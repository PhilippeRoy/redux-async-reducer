language: node_js
node_js:
  - node
  - lts/*
cache:
  directories:
  - node_modules

# This is needed to avoid building all the tags pushed by travis
branches:
  except:
  - /^v?\d+\.\d+\.\d+$/

before_install:
  # Create a git tag of the new version to use
  # If package.json major and minor versions match last tag, then increment last tag. Else use package.json major.minor.0.
  - "{ sed -nE 's/^[ \\t]*\"version\": \"([0-9]{1,}\\.[0-9]{1,}\\.)[0-9x]{1,}\",$/\\1/p' package.json; git describe --abbrev=0 | sed -E 's/^v([0-9]{1,}\\.[0-9]{1,}\\.)([0-9]{1,})$/\\1 \\2/g'; } | tr \"\\n\" \" \" | awk '{printf($1==$2?\"v\"$2$3+1:\"v\"$1\"0\")}' | xargs -I {} git tag -a {} -m \"{}\"\n"
  # Update package.json based on the git tag we just created
  - npm --no-git-tag-version version from-git

jobs:
  include:
    - stage: Github Release
      script: echo "Updateing GitHub tags ..."
      deploy:
        provider: script
        skip_cleanup: true
        script: git push --tags
        on:
          repo: PhilippeRoy/redux-async-reducer
          branch: master
    - stage: npm release
      deploy:
        provider: npm
        email: philippe.j.roy@gmail.com
        api_key:
          secure: hC93XR7oresvi3o7lGdfo7Jgi3BH09NV2I4WCWmO3E/iBgu2LNA4vP97AgiHzMBkyVSEs2fu+0BAqqeOc9CLC4cdC4JpC8TCKD8B+/qu8rQXXh7Q8KwQMhxkKM2T9CzuFUGMSXYBvy7kW2cmf8BWJ/wKJ9ucOj7MTN4jOVc5vv1cR+mULCJEy9Xqa1hlyay+3JBPZcZxVwIIUBFILq/Qf+4oXD98p0vmE77rWmCB2gN425ZfbCTucVI1HRzzaBbm74VuwpAuyLr36qRRwZjU8ZwOAEjrGCKdKQ/09e0ntchLgeId83Rv3B2jA7oY3qdrON0QibneY4tYsVnnYPWBNWwGB22Su2VouKUo8g04FeF+7vvrrNJCauloL/iaWXyjK95jrribJbPtSSdKX4nT8nX9D1xzoKkNlm1K1n72wCL1f6d+c5DCxJImcRV+mKN5OFy4QxmFwUhxvLLFaNSICm334bnxshJF8WEwURAsLcenAFFSmTGFeceVBWE4k0CYNlegQeVe/cLW1OWpQipwa0d6EEcXDO1wTtji4X75HO76awy02HQEaZRN+/hthXqi12TjGRvw7y6qsJj3u/Yf4k3W8nXBBPw7WvL6pngr//DOVLVa/NWcHddoy8dhENykQP2Wg2dG13Nfh394nS407Ch8xY8kG5JBZwpZFazbG7M=
        on:
          tags: true
          repo: PhilippeRoy/redux-async-reducer
          branch: master

            