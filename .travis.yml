language: node_js
node_js:
  - node
  - lts/*
cache:
  directories:
  - node_modules

# This is needed to avoid building all the tags pushed by travis
branches:
  except:
  - /^v?\d+\.\d+\.\d+$/

before_install:
  # Create a git tag of the new version to use
  # If package.json major and minor versions match last tag, then increment last tag. Else use package.json major.minor.0.
  - "{ sed -nE 's/^[ \\t]*\"version\": \"([0-9]{1,}\\.[0-9]{1,}\\.)[0-9x]{1,}\",$/\\1/p' package.json; git describe --abbrev=0 | sed -E 's/^v([0-9]{1,}\\.[0-9]{1,}\\.)([0-9]{1,})$/\\1 \\2/g'; } | tr \"\\n\" \" \" | awk '{printf($1==$2?\"v\"$2$3+1:\"v\"$1\"0\")}' | xargs -I {} git tag -a {} -m \"{}\"\n"
  # Update package.json based on the git tag we just created
  - npm --no-git-tag-version version from-git

jobs:
  include:
    - stage: Github Release
      script: echo "Updateing GitHub tags ..."
      deploy:
        - provider: script
          skip_cleanup: true
          api_key:
          secure: dGDyUWVz/lCjad1m2mjlbX5tBwpEYvNuAIQPwlCd/Jlq7735j5IGfHa7zbtXD4imsIyqOAJxu0desSG0OQNrCSqguuNt4pyhDeiFv7Rv4T9syVQ2FXRS4RvZhREBc1sAvxE2PUP7Sqyn5EvM8/1EmLWb47ZJnE1dBc/OJYmRwtERll4BkNRaKGCTChiLfmD1Pl3Ai10fng9A+52fDOPc0JC7Mmf42cDtuUce5Y1rxhXU0c3dlGLNKlYQ7WtemssAytsiXGSCNg0uw1Kfw/IDxlg50lq4im6y1CUuZt0n+QuQ6qV8ZuY43w7p1020+ExqCb+kk9mfWhw27YilVyTpoPuK4jc+vLqxPkr/z7Wo2irVAMAk77c6TJeJ35S0NTKGaeTPZ0udTqFYKZ65uT5PSX77/5vLFlyhSzTBWxTLDQxd//B1KrLP40cXmemYrDB0SU7XwBX4e2b+CScm88Htrg7tkKtZPMoBtDIpPm7Lmo6XJXm6rv6rUPxTi8iRXqfAvaelXrignFV7w9pX2CJcABLmL3c88JAic9TBscWMaRA29UdMtIIKOgR9Xo9BnEtV+HhWr1ey7tTuYvdw9Pve/wBp3CBwvzyUW5aP9me+rSj3HEsR6xw81fMf2dFQLZJxTIL1MC7WZJ/Y2K3Qd6MilUVXOJodfLgPAc7wRI+cAM0=
          script: git push --tags
          on:
            branch: master